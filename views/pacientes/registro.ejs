<% const body = `
<div class="container-fluid mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">

            <!-- Cabecera: Título + Volver -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="bi bi-person-plus-fill text-success"></i> Registrar Nuevo Paciente</h2>
                    <p class="text-muted mb-0">Ingresa los datos personales y una fotografía de la sonrisa</p>
                </div>
                <a href="/pacientes" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver a la lista
                </a>
            </div>

            <!-- Errores -->
            ${ errores && errores.length > 0 ? 
                '<div class="alert alert-danger alert-dismissible fade show">' +
                    '<strong><i class="bi bi-exclamation-triangle-fill"></i> Errores en el formulario:</strong>' +
                    '<ul class="mb-0 mt-2">' +
                        errores.map(function(error) { return '<li>' + error + '</li>'; }).join('') +
                    '</ul>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>'
            : '' }

            <!-- Formulario en Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <form action="/pacientes" method="POST" enctype="multipart/form-data" id="formRegistro">
                        <!-- Sección: Datos Personales -->
                        <div class="mb-5">
                            <h4 class="border-bottom pb-2 mb-4 text-primary">
                                <i class="bi bi-person-lines-fill"></i> Datos Personales
                            </h4>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="ci" class="form-label"><strong>Carnet de Identidad *</strong></label>
                                    <input type="text" id="ci" name="ci" class="form-control" required 
                                           value="${ datos.ci || '' }" placeholder="Ej: 12345678" maxlength="15">
                                    <div class="form-text">Solo números, sin puntos ni guiones</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="sexo" class="form-label"><strong>Sexo *</strong></label>
                                    <select id="sexo" name="sexo" class="form-select" required>
                                        <option value="">Seleccione...</option>
                                        <option value="M" ${ datos.sexo === 'M' ? 'selected' : '' }>Masculino</option>
                                        <option value="F" ${ datos.sexo === 'F' ? 'selected' : '' }>Femenino</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="nombres" class="form-label"><strong>Nombres *</strong></label>
                                    <input type="text" id="nombres" name="nombres" class="form-control" required 
                                           value="${ datos.nombres || '' }" placeholder="Ej: Juan Carlos">
                                </div>
                                <div class="col-md-6">
                                    <label for="apellidos" class="form-label"><strong>Apellidos *</strong></label>
                                    <input type="text" id="apellidos" name="apellidos" class="form-control" required 
                                           value="${ datos.apellidos || '' }" placeholder="Ej: Pérez Gómez">
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="fecha_nacimiento" class="form-label"><strong>Fecha de Nacimiento *</strong></label>
                                    <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control" required 
                                           value="${ datos.fecha_nacimiento || '' }">
                                </div>
                                <div class="col-md-6">
                                    <label for="telefono" class="form-label"><strong>Teléfono</strong></label>
                                    <input type="tel" id="telefono" name="telefono" class="form-control" 
                                           value="${ datos.telefono || '' }" placeholder="Ej: 79012345">
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="direccion" class="form-label"><strong>Dirección</strong></label>
                                <textarea id="direccion" name="direccion" class="form-control" rows="3" 
                                          placeholder="Calle, número, barrio, zona...">${ datos.direccion || '' }</textarea>
                            </div>
                        </div>

                        <!-- Sección: Fotografía -->
                        <div class="mb-5">
                            <h4 class="border-bottom pb-2 mb-4 text-primary">
                                <i class="bi bi-camera-fill"></i> Fotografía del Paciente
                            </h4>
                            <p class="text-muted mb-3">
                                <i class="bi bi-lightbulb"></i> 
                                Sube una foto <strong>frontal de la sonrisa</strong> con buena iluminación (sin flash). 
                                Esto mejora la precisión de la IA.
                            </p>

                            <div class="row">
                                <div class="col-lg-8 mx-auto">
                                    <label for="imagen" class="form-label"><strong>Imagen de Sonrisa (Opcional)</strong></label>
                                    <input type="file" id="imagen" name="imagen" class="form-control" 
                                           accept="image/jpeg,image/jpg,image/png,image/webp" onchange="previsualizarImagen(event)">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> 
                                        Formatos: JPG, PNG, WebP - Máx. 5MB
                                    </div>
                                </div>
                            </div>

                            <!-- Vista previa -->
                            <div id="imagePreview" class="mt-4 text-center" style="display: none;">
                                <p class="text-success fw-bold"><i class="bi bi-eye"></i> Vista previa:</p>
                                <img id="previewImg" src="" alt="Vista previa" 
                                     class="img-fluid rounded shadow-sm" style="max-height: 350px; border: 2px dashed #0d6efd;">
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex flex-column flex-md-row gap-3 justify-content-end mt-4 pt-3 border-top">
                            <a href="/pacientes" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="bi bi-check2-circle"></i> Registrar Paciente
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function previsualizarImagen(event) {
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const file = event.target.files[0];

        if (file) {
            // Validar tamaño (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('La imagen no debe superar los 5MB');
                event.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    }

    // Validación en cliente
    document.getElementById('formRegistro').addEventListener('submit', function(e) {
        const ci = document.getElementById('ci').value.trim();
        if (!/^\\d+$/.test(ci)) {
            e.preventDefault();
            showToast('El CI debe contener solo números', 'danger');
            return;
        }

        const fechaNac = new Date(document.getElementById('fecha_nacimiento').value);
        const hoy = new Date();
        if (fechaNac > hoy) {
            e.preventDefault();
            showToast('La fecha de nacimiento no puede ser futura', 'danger');
            return;
        }
    });

    // Toast reutilizable
    function showToast(message, type) {
        const toastHTML = '<div class="toast align-items-center text-white bg-' + type + ' border-0 position-fixed top-0 end-0 p-3" style="z-index: 1100;" role="alert">' +
            '<div class="d-flex">' +
                '<div class="toast-body">' + message + '</div>' +
                '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
            '</div>' +
        '</div>';
        document.body.insertAdjacentHTML('beforeend', toastHTML);
        new bootstrap.Toast(document.querySelector('.toast')).show();
    }
</script>
`; %>

<%- include('../layouts/main', { title: title, body: body }) %>
