<%
const imagenPrincipal = paciente.imagenes && paciente.imagenes.length > 0 
    ? (paciente.imagenes.find(img => img.es_principal) || paciente.imagenes[0])
    : null;

const body = `
<div class="container-fluid mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <!-- Cabecera con título y botón volver -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1"><i class="bi bi-person-fill-gear text-primary"></i> Editar Paciente</h2>
                    <p class="text-muted mb-0">Actualiza los datos personales y fotografía del paciente</p>
                </div>
                <a href="/pacientes/${paciente.id}/perfil" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al perfil
                </a>
            </div>

            <!-- Mensajes de error -->
            ${errores && errores.length > 0 ? `
                <div class="alert alert-danger alert-dismissible fade show">
                    <strong><i class="bi bi-exclamation-triangle-fill"></i> Errores encontrados:</strong>
                    <ul class="mb-0 mt-2">
                        ${errores.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            ` : ''}

            <!-- Formulario principal -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form action="/pacientes/${paciente.id}" method="POST" enctype="multipart/form-data" id="formEditar">
                        <input type="hidden" name="_method" value="PUT">

                        <!-- Sección: Datos Personales -->
                        <div class="mb-5">
                            <h4 class="border-bottom pb-2 mb-4 text-primary">
                                <i class="bi bi-person-lines-fill"></i> Datos Personales
                            </h4>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="ci" class="form-label"><strong>Carnet de Identidad *</strong></label>
                                    <input type="text" id="ci" name="ci" class="form-control" value="${paciente.ci}" readonly disabled>
                                    <div class="form-text text-muted">El CI no se puede modificar</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="sexo" class="form-label"><strong>Sexo *</strong></label>
                                    <select id="sexo" name="sexo" class="form-select" required>
                                        <option value="M" ${paciente.sexo === 'M' ? 'selected' : ''}>Masculino</option>
                                        <option value="F" ${paciente.sexo === 'F' ? 'selected' : ''}>Femenino</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="nombres" class="form-label"><strong>Nombres *</strong></label>
                                    <input type="text" id="nombres" name="nombres" class="form-control" required value="${paciente.nombres}">
                                </div>
                                <div class="col-md-6">
                                    <label for="apellidos" class="form-label"><strong>Apellidos *</strong></label>
                                    <input type="text" id="apellidos" name="apellidos" class="form-control" required value="${paciente.apellidos}">
                                </div>
                            </div>

                            <div class="row g-3 mt-3">
                                <div class="col-md-6">
                                    <label for="fecha_nacimiento" class="form-label"><strong>Fecha de Nacimiento *</strong></label>
                                    <input type="date" id="fecha_nacimiento" name="fecha_nacimiento" class="form-control" required 
                                           value="${paciente.fecha_nacimiento ? new Date(paciente.fecha_nacimiento).toISOString().split('T')[0] : ''}">
                                </div>
                                <div class="col-md-6">
                                    <label for="telefono" class="form-label"><strong>Teléfono</strong></label>
                                    <input type="tel" id="telefono" name="telefono" class="form-control" value="${paciente.telefono || ''}">
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="direccion" class="form-label"><strong>Dirección</strong></label>
                                <textarea id="direccion" name="direccion" class="form-control" rows="3" placeholder="Calle, número, barrio...">${paciente.direccion || ''}</textarea>
                            </div>
                        </div>

                        <!-- Sección: Fotografía -->
                        <div class="mb-5">
                            <h4 class="border-bottom pb-2 mb-4 text-primary">
                                <i class="bi bi-camera-fill"></i> Actualizar Fotografía
                            </h4>

                            <!-- Imagen actual -->
                            <div class="text-center mb-4">
                                ${imagenPrincipal 
                                    ? `
                                        <div class="position-relative d-inline-block">
                                            <img src="${imagenPrincipal.ruta_imagen}" alt="Foto actual" 
                                                 class="img-thumbnail" style="max-width: 250px; height: auto; border-radius: 12px;">
                                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                                Actual <i class="bi bi-check"></i>
                                            </span>
                                        </div>
                                        <p class="mt-2 text-muted small">Imagen principal actual</p>
                                    `
                                    : '<p class="text-muted"><i class="bi bi-person-x"></i> Sin fotografía registrada</p>'
                                }
                            </div>

                            <!-- Subir nueva imagen -->
                            <div class="row">
                                <div class="col-lg-8 mx-auto">
                                    <label for="imagen" class="form-label"><strong>Nueva Imagen (Opcional)</strong></label>
                                    <input type="file" id="imagen" name="imagen" class="form-control" 
                                           accept="image/jpeg,image/jpg,image/png,image/webp" onchange="previsualizarImagen(event)">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Si subes una nueva imagen, reemplazará la actual. Formatos: JPG, PNG, WebP.
                                    </div>
                                </div>
                            </div>

                            <!-- Vista previa -->
                            <div id="imagePreview" class="mt-4 text-center" style="display: none;">
                                <p class="text-success fw-bold"><i class="bi bi-eye"></i> Vista previa de la nueva imagen:</p>
                                <img id="previewImg" src="" alt="Vista previa" 
                                     class="img-fluid rounded shadow-sm" style="max-height: 300px; border: 2px dashed #0d6efd;">
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex flex-column flex-md-row gap-3 justify-content-end mt-4 pt-3 border-top">
                            <a href="/pacientes/${paciente.id}/perfil" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check2-circle"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function previsualizarImagen(event) {
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    }
</script>
`;
%>

<%- include('../layouts/main', { title: title, body: body }) %>