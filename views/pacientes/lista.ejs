<% 
const body = `
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container-fluid px-4">
    <!-- Header con breadcrumb -->
    <div class="page-header-modern">
        <div class="header-content">
            <div class="breadcrumb-nav">
             </div>
            <h1 class="page-title">
                <i class="bi bi-people-fill"></i> Gestión de Pacientes
            </h1>
        </div>
        <div class="header-actions">
            <a href="/pacientes/nuevo" class="btn btn-primary-modern">
                <i class="bi bi-person-plus-fill"></i> Nuevo Paciente
            </a>
        </div>
    </div>

    <!-- Estadísticas mejoradas -->
    <div class="stats-grid-modern">
        <div class="stat-card-modern stat-primary">
            <div class="stat-icon-modern">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-details">
                <div class="stat-value-modern">${estadisticas.total_pacientes || 0}</div>
                <div class="stat-label-modern">Total de Pacientes</div>
                <div class="stat-trend">
                    <i class="bi bi-graph-up"></i>
                    <span>Registro activo</span>
                </div>
            </div>
        </div>

        <div class="stat-card-modern stat-success">
            <div class="stat-icon-modern">
                <i class="bi bi-clipboard2-check"></i>
            </div>
            <div class="stat-details">
                <div class="stat-value-modern">${estadisticas.pacientes_con_proyecciones || 0}</div>
                <div class="stat-label-modern">Con Proyecciones</div>
                <div class="stat-trend">
                    <i class="bi bi-check-circle"></i>
                    <span>${estadisticas.total_pacientes > 0 ? Math.round((estadisticas.pacientes_con_proyecciones / estadisticas.total_pacientes) * 100) : 0}% del total</span>
                </div>
            </div>
        </div>

        <div class="stat-card-modern stat-info">
            <div class="stat-icon-modern">
                <i class="bi bi-file-medical"></i>
            </div>
            <div class="stat-details">
                <div class="stat-value-modern">${estadisticas.total_proyecciones || 0}</div>
                <div class="stat-label-modern">Proyecciones Totales</div>
                <div class="stat-trend">
                    <i class="bi bi-bar-chart"></i>
                    <span>Generadas</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Búsqueda avanzada -->
    <div class="search-card-modern">
        <form method="GET" action="/pacientes" class="search-form-modern">
            <div class="search-header">
                <i class="bi bi-search"></i>
                <h3>Buscar Pacientes</h3>
            </div>
            <div class="search-inputs">
                <div class="input-group-modern">
                    <label for="ci" class="input-label-modern">
                        <i class="bi bi-person-vcard"></i> Carnet de Identidad
                    </label>
                    <input 
                        type="text" 
                        id="ci" 
                        name="ci" 
                        class="form-control-modern" 
                        placeholder="Ej: 12345678"
                        value="${filtros.ci || ''}"
                    >
                </div>

                <div class="input-group-modern">
                    <label for="nombre" class="input-label-modern">
                        <i class="bi bi-person"></i> Nombre o Apellido
                    </label>
                    <input 
                        type="text" 
                        id="nombre" 
                        name="nombre" 
                        class="form-control-modern" 
                        placeholder="Buscar por nombre..."
                        value="${filtros.nombre || ''}"
                    >
                </div>

                <div class="search-actions">
                    <button type="submit" class="btn btn-search-modern">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    ${filtros.ci || filtros.nombre ? `
                        <a href="/pacientes" class="btn btn-reset-modern">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </a>
                    ` : ''}
                </div>
            </div>
        </form>
    </div>

    <!-- Tabla mejorada -->
    <div class="table-card-modern">
        <div class="table-header-modern">
            <h3><i class="bi bi-list-ul"></i> Listado de Pacientes</h3>
            <div class="table-info">
                <span class="badge badge-secondary-modern">
                    ${pacientes ? pacientes.length : 0} resultado(s)
                </span>
            </div>
        </div>

        <div class="table-responsive-modern">
            <table class="data-table-modern">
                <thead>
                    <tr>
                        <th><i class="bi bi-hash"></i> CI</th>
                        <th><i class="bi bi-person"></i> Paciente</th>
                        <th><i class="bi bi-clipboard2-pulse"></i> Proyecciones</th>
                        <th><i class="bi bi-calendar-event"></i> Última Actividad</th>
                        <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    ${pacientes && pacientes.length > 0 ? pacientes.map(paciente => `
                        <tr class="table-row-hover">
                            <td class="font-mono">${paciente.ci}</td>
                            <td>
                                <div class="patient-info">
                                    <div class="patient-avatar">
                                        ${paciente.nombres.charAt(0)}${paciente.apellidos.charAt(0)}
                                    </div>
                                    <div class="patient-details">
                                        <strong class="patient-name">${paciente.nombres} ${paciente.apellidos}</strong>
                                        <small class="patient-id">ID: #${paciente.ci}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${paciente.total_proyecciones > 0 
                                    ? `<span class="badge badge-success-modern">
                                        <i class="bi bi-check-circle-fill"></i> ${paciente.total_proyecciones} proyección(es)
                                       </span>`
                                    : '<span class="badge badge-secondary-modern"><i class="bi bi-dash-circle"></i> Sin proyecciones</span>'
                                }
                            </td>
                            <td>
                                ${paciente.ultima_proyeccion 
                                    ? `<span class="date-badge">
                                        <i class="bi bi-calendar3"></i> 
                                        ${new Date(paciente.ultima_proyeccion).toLocaleDateString('es-BO')}
                                       </span>`
                                    : '<span class="text-muted-modern">Sin actividad</span>'
                                }
                            </td>
                            <td>
                                <div class="action-buttons-modern">
                                    <a 
                                        href="/proyecciones/nueva?paciente_id=${paciente.ci}" 
                                        class="btn-action btn-primary-action" 
                                        title="Generar proyección"
                                    >
                                        <i class="bi bi-magic"></i>
                                    </a>
                                    <a 
                                        href="/pacientes/${paciente.ci}/perfil" 
                                        class="btn-action btn-info-action" 
                                        title="Ver perfil"
                                    >
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a 
                                        href="/pacientes/${paciente.ci}/editar" 
                                        class="btn-action btn-warning-action" 
                                        title="Editar"
                                    >
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button 
                                        onclick="eliminarPaciente('${paciente.ci}', '${paciente.nombres}')" 
                                        class="btn-action btn-danger-action" 
                                        title="Eliminar"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('') : `
                        <tr>
                            <td colspan="5" class="empty-state-modern">
                                <div class="empty-content">
                                    <i class="bi bi-inbox"></i>
                                    <h4>No hay pacientes registrados</h4>
                                    <p>Comienza registrando tu primer paciente</p>
                                    <a href="/pacientes/nuevo" class="btn btn-primary-modern">
                                        <i class="bi bi-plus-circle"></i> Registrar Paciente
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div id="toast-container" class="toast-container"></div>

<script src="/js/pacientes.js"></script>
<script>
    function eliminarPaciente(id, nombre) {
        if (confirm('¿Está seguro que desea eliminar al paciente ' + nombre + '?\\n\\nEsta acción también eliminará:\\n- Todas sus imágenes\\n- Todas sus proyecciones\\n\\nEsta acción no se puede deshacer.')) {
            // Mostrar loading
            showToast('Eliminando paciente...', 'info');
            
            fetch('/pacientes/' + id, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Paciente eliminado exitosamente', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error al eliminar el paciente', 'error');
            });
        }
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        
        const icon = type === 'success' ? 'check-circle-fill' : 
                     type === 'error' ? 'x-circle-fill' : 'info-circle-fill';
        
        toast.innerHTML = '<i class="bi bi-' + icon + '"></i><span>' + message + '</span>';
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>

<style>
/* Variables de color */
:root {
    --primary-color: #3498db;
    --success-color: #2ecc71;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --info-color: #3498db;
    --secondary-color: #95a5a6;
    --dark-color: #2c3e50;
    --light-bg: #f8f9fa;
    --border-color: #e1e8ed;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
}

/* Header mejorado */
.page-header-modern {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--border-color);
}

.breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--secondary-color);
    margin-bottom: 0.75rem;
}

.breadcrumb-link {
    color: var(--secondary-color);
    text-decoration: none;
    transition: color 0.2s;
}

.breadcrumb-link:hover {
    color: var(--primary-color);
}

.breadcrumb-current {
    color: var(--dark-color);
    font-weight: 500;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--dark-color);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

/* Estadísticas modernas */
.stats-grid-modern {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card-modern {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    border-left: 4px solid;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card-modern:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.stat-card-modern.stat-primary { border-color: var(--primary-color); }
.stat-card-modern.stat-success { border-color: var(--success-color); }
.stat-card-modern.stat-info { border-color: var(--info-color); }

.stat-icon-modern {
    width: 64px;
    height: 64px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    flex-shrink: 0;
}

.stat-primary .stat-icon-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-success .stat-icon-modern {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.stat-info .stat-icon-modern {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.stat-value-modern {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark-color);
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label-modern {
    font-size: 0.875rem;
    color: var(--secondary-color);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.stat-trend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.75rem;
    color: var(--success-color);
}

/* Búsqueda moderna */
.search-card-modern {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
}

.search-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    color: var(--dark-color);
}

.search-header i {
    color: var(--primary-color);
}

.search-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 1.5rem;
    align-items: end;
}

.input-group-modern {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.input-label-modern {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-control-modern {
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.938rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-control-modern:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.search-actions {
    display: flex;
    gap: 0.75rem;
}

.btn-search-modern, .btn-reset-modern, .btn-primary-modern {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

.btn-search-modern {
    background: var(--primary-color);
    color: white;
}

.btn-search-modern:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-reset-modern {
    background: var(--light-bg);
    color: var(--secondary-color);
}

.btn-primary-modern {
    background: var(--primary-color);
    color: white;
}

.btn-primary-modern:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* Tabla moderna */
.table-card-modern {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.table-header-modern {
    padding: 1.5rem;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.table-header-modern h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-responsive-modern {
    overflow-x: auto;
}

.data-table-modern {
    width: 100%;
    border-collapse: collapse;
}

.data-table-modern thead {
    background: var(--light-bg);
}

.data-table-modern th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--dark-color);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.data-table-modern td {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.table-row-hover {
    transition: background-color 0.2s;
}

.table-row-hover:hover {
    background: var(--light-bg);
}

/* Info del paciente */
.patient-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.patient-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--info-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.patient-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.patient-name {
    color: var(--dark-color);
    font-size: 0.938rem;
}

.patient-id {
    color: var(--secondary-color);
    font-size: 0.75rem;
}

/* Badges */
.badge-success-modern {
    background: #d4edda;
    color: #155724;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-size: 0.813rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.badge-secondary-modern {
    background: var(--light-bg);
    color: var(--secondary-color);
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-size: 0.813rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
}

.date-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--secondary-color);
    font-size: 0.875rem;
}

/* Botones de acción */
.action-buttons-modern {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.btn-action {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 1rem;
    text-decoration: none;
}

.btn-primary-action {
    background: #e3f2fd;
    color: var(--primary-color);
}

.btn-primary-action:hover {
    background: var(--primary-color);
    color: white;
    transform: translateY(-2px);
}

.btn-info-action {
    background: #e0f7fa;
    color: #00acc1;
}

.btn-info-action:hover {
    background: #00acc1;
    color: white;
    transform: translateY(-2px);
}

.btn-warning-action {
    background: #fff3e0;
    color: var(--warning-color);
}

.btn-warning-action:hover {
    background: var(--warning-color);
    color: white;
    transform: translateY(-2px);
}

.btn-danger-action {
    background: #ffebee;
    color: var(--danger-color);
}

.btn-danger-action:hover {
    background: var(--danger-color);
    color: white;
    transform: translateY(-2px);
}

/* Estado vacío */
.empty-state-modern {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-content i {
    font-size: 4rem;
    color: var(--secondary-color);
    margin-bottom: 1rem;
}

.empty-content h4 {
    color: var(--dark-color);
    margin-bottom: 0.5rem;
}

.empty-content p {
    color: var(--secondary-color);
    margin-bottom: 1.5rem;
}

/* Toast notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

.toast {
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast-success { border-left: 4px solid var(--success-color); }
.toast-error { border-left: 4px solid var(--danger-color); }
.toast-info { border-left: 4px solid var(--info-color); }

.toast i {
    font-size: 1.25rem;
}

.toast-success i { color: var(--success-color); }
.toast-error i { color: var(--danger-color); }
.toast-info i { color: var(--info-color); }

/* Responsive */
@media (max-width: 768px) {
    .search-inputs {
        grid-template-columns: 1fr;
    }
    
    .page-header-modern {
        flex-direction: column;
        gap: 1rem;
    }
    
    .action-buttons-modern {
        flex-wrap: wrap;
    }
}

.font-mono {
    font-family: 'Courier New', monospace;
    font-weight: 600;
}

.text-muted-modern {
    color: var(--secondary-color);
    font-size: 0.875rem;
}
</style>
`;
%>

<%- include('../layouts/main', { title: title, body: body }) %>