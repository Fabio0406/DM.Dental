<% 
const formatearFecha = (fecha) => {
    if (!fecha) return 'N/A';
    const d = new Date(fecha);
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const anio = d.getFullYear();
    return `${dia}/${mes}/${anio}`;
};

const formatearMoneda = (valor) => {
    return new Intl.NumberFormat('es-BO', { 
        style: 'currency', 
        currency: 'BOB',
        minimumFractionDigits: 2 
    }).format(valor || 0);
};

// Calcular total general
let totalGeneral = 0;
if (solicitud.detalles) {
    solicitud.detalles.forEach(det => {
        totalGeneral += det.costo_total || 0;
    });
}

const body = `
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3><i data-lucide="file-text"></i> Solicitud de Pedido</h3>
                    <p class="text-muted mb-0">${solicitud.nro_solicitud}</p>
                </div>
                <div class="btn-group">
                    <a href="/solicitudes/exportar/${solicitud.id_solicitud}" 
                       class="btn btn-success" target="_blank">
                        <i data-lucide="file-down"></i> Exportar PDF
                    </a>
                    <a href="/solicitudes/editar/${solicitud.id_solicitud}" 
                       class="btn btn-warning">
                        <i data-lucide="edit"></i> Editar
                    </a>
                    <a href="/solicitudes" class="btn btn-outline-secondary">
                        <i data-lucide="arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci처n de la solicitud -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i data-lucide="info"></i> Informaci처n de la Solicitud</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>N째 Solicitud:</strong><br>
                            <span class="badge bg-info fs-6">${solicitud.nro_solicitud}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Fecha:</strong><br>
                            ${formatearFecha(solicitud.fecha)}
                        </div>
                        <div class="col-md-3">
                            <strong>Material:</strong><br>
                            <span class="badge bg-secondary">${solicitud.material}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Solicitante:</strong><br>
                            ${solicitud.solicitante}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de detalles -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i data-lucide="list"></i> Detalle de Insumos</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">Item</th>
                                    <th style="width: 100px;">C처digo</th>
                                    <th>Detalle</th>
                                    <th style="width: 100px;">Unidad</th>
                                    <th style="width: 80px;" class="text-center">Cantidad</th>
                                    <th style="width: 120px;" class="text-end">P. Unitario</th>
                                    <th style="width: 120px;" class="text-end">P. Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${solicitud.detalles && solicitud.detalles.length > 0 ? 
                                    solicitud.detalles.map((det, index) => `
                                        <tr>
                                            <td class="text-center">${index + 1}</td>
                                            <td><code>${det.codigo}</code></td>
                                            <td>${det.nombre_generico}</td>
                                            <td class="text-center">${det.presentacion || 'Unidad'}</td>
                                            <td class="text-center">${det.cantidad}</td>
                                            <td class="text-end">${formatearMoneda(det.costo_unitario)}</td>
                                            <td class="text-end">${formatearMoneda(det.costo_total)}</td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                No hay insumos en esta solicitud
                                            </td>
                                        </tr>
                                    `
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="6" class="text-end"><strong>TOTAL GENERAL:</strong></td>
                                    <td class="text-end"><strong>${formatearMoneda(totalGeneral)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Reinicializar Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
`;
%>

<%- include('../layouts/main', { title: title, body: body }) %>
