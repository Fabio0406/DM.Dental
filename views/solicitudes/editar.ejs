<% 
// Preparar items existentes como JSON
const itemsExistentes = solicitud.detalles 
    ? solicitud.detalles.map(det => ({
        id_insumo: det.id_insumo,
        codigo: det.codigo,
        nombre: det.nombre_generico,
        presentacion: det.presentacion || 'Unidad',
        cantidad: det.cantidad,
        precio_unitario: det.costo_unitario || 0,
        precio_total: det.costo_total || 0
    }))
    : [];

const body = `
<div class="container-fluid mt-4" id="contenedorSolicitud" data-items='${JSON.stringify(itemsExistentes)}'>
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3><i class="bi bi-pencil-square"></i> Editar Solicitud de Pedido</h3>
                    <p class="text-muted mb-0">${solicitud.nro_solicitud}</p>
                </div>
                <a href="/solicitudes" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>

    ${locals.error ? `
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle-fill"></i> ${error}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    ` : ''}

    <form id="formSolicitud" method="POST" action="/solicitudes/editar/${solicitud.id_solicitud}">
        <!-- Selector de insumos -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Agregar Insumos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Seleccionar Insumo</label>
                                <select class="form-select" id="selectInsumo">
                                    <option value="">-- Seleccione un insumo --</option>
                                    ${insumos.map(ins => 
                                        `<option value="${ins.id_insumo}" 
                                                data-codigo="${ins.codigo}"
                                                data-nombre="${ins.nombre_generico}"
                                                data-presentacion="${ins.presentacion || 'Unidad'}"
                                                data-precio="${ins.costo_unitario || 0}">
                                            ${ins.codigo} - ${ins.nombre_generico}
                                        </option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="inputCantidad" 
                                       min="1" value="1" placeholder="Cantidad">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success w-100" onclick="agregarInsumo()">
                                    <i class="bi bi-plus-lg"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de items agregados -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Items de la Solicitud</h6>
                        <span class="badge bg-primary" id="totalItems">0 items</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0" id="tablaItems">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;">Item</th>
                                        <th style="width: 100px;">Código</th>
                                        <th>Detalle</th>
                                        <th style="width: 100px;">Unidad</th>
                                        <th style="width: 80px;">Cantidad</th>
                                        <th style="width: 120px;">P. Unitario</th>
                                        <th style="width: 120px;">P. Total</th>
                                        <th style="width: 60px;">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyItems">
                                    <tr id="filaVacia">
                                        <td colspan="8" class="text-center py-4 text-muted">
                                            No hay insumos agregados.
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="6" class="text-end"><strong>TOTAL GENERAL:</strong></td>
                                        <td class="text-end"><strong id="totalGeneral">Bs. 0.00</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de acción -->
        <div class="row mt-4">
            <div class="col-12 text-end">
                <a href="/solicitudes" class="btn btn-secondary me-2">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="btnGuardar" disabled>
                    <i class="bi bi-floppy"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Script externo para la lógica de edición -->
<script src="/js/solicitud-editar.js"></script>
`;
%>

<%- include('../layouts/main', { title: title, body: body }) %>